#
# Copyright (C) 2015 VMware, Inc. All Rights Reserved.
#
# Licensed under the GNU Lesser General Public License v2.1 (the "License");
# you may not use this file except in compliance with the License. The terms
# of the License are located in the COPYING file of this distribution.
#

AT_TESTED([tdnf])

m4_define([TDNF_CLI],[[$abs_top_builddir/tools/cli/tdnf]])

m4_define([TDNF_CHROOT],[[$abs_top_builddir/tests/testroot]])

m4_define([TDNF_CLI_W_CHROOT],[[$abs_top_builddir/tools/cli/tdnf --config "$abs_top_builddir/tests/testroot/etc/tdnf/tdnf.conf" --installroot $abs_top_builddir/tests/testroot]])

m4_define([TDNF_CHROOT_INIT],[[
rm -rf $abs_top_builddir/tests/testroot
mkdir $abs_top_builddir/tests/testroot
rpm --root $abs_top_builddir/tests/testroot --initdb
mkdir -p $abs_top_builddir/tests/testroot/var/cache/tdnf
mkdir -p $abs_top_builddir/tests/testroot/etc/yum.repos.d
mkdir -p $abs_top_builddir/tests/testroot/etc/tdnf
mkdir -p $abs_top_builddir/tests/testroot/etc/pki/rpm-gpg
mkdir $abs_top_builddir/tests/testroot/BUILD
mkdir $abs_top_builddir/tests/testroot/RPMS
mkdir $abs_top_builddir/tests/testroot/SRPMS

cat << EOF > $abs_top_builddir/tests/testroot/etc/tdnf/tdnf.conf
[main]
repodir=$abs_top_builddir/tests/testroot/etc/yum.repos.d
cachedir=$abs_top_builddir/tests/testroot/var/cache/tdnf
EOF

cat << EOF > $abs_top_builddir/tests/testroot/etc/pki/rpm-gpg/VMWARE-RPM-GPG-KEY
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v1.4.7 (GNU/Linux)

mI0ESAP+VwEEAMZylR8dOijUPNn3He3GdgM/kOXEhn3uQl+sRMNJUDm1qebi2D5b
Qa7GNBIlXm3DEMAS+ZlkiFQ4WnhUq5awEXU7MGcWCEGfums5FckV2tysSfn7HeWd
9mkEnsY2CUZF54lyKfY0f+vdFd6QdYo6b+YxGnLyiunEYHXSEo1TNj1vABEBAAG0
QlZNd2FyZSwgSW5jLiAtLSBMaW51eCBQYWNrYWdpbmcgS2V5IC0tIDxsaW51eC1w
YWNrYWdlc0B2bXdhcmUuY29tPoi8BBMBAgAmBQJIA/5XAhsDBQkRcu4ZBgsJCAcD
AgQVAggDBBYCAwECHgECF4AACgkQwLXgq2b9SUkw0AP/UlmWQIjMNcYfTKCOOyFx
Csl3bY5OZ6HZs4qCRvzESVTyKs0YN1gX5YDDRmE5EbaqSO7OLriA7p81CYhstYID
GjVTBqH/zJz/DGKQUv0A7qGvnX4MDt/cvvgEXjGpeRx42le/mkPsHdwbG/8jKveY
S/eu0g9IenS49i0hcOnjShGIRgQQEQIABgUCSAQWfAAKCRD1ZoIQEyn810LTAJ9k
IOziCqa/awfBvlLq4eRgN/NnkwCeJLOuL6eAueYjaODTcFEGKUXlgM4=
=bXtp
-----END PGP PUBLIC KEY BLOCK-----
EOF
]])

m4_define([TDNF_BUILD_INSTALL_RPMS],[[
rpmbuild  --define "_topdir $abs_top_builddir/tests/testroot" -r $abs_top_builddir/tests/testroot -ba $abs_top_builddir/tests/specs/*.spec
createrepo $abs_top_builddir/tests/testroot/RPMS
modifyrepo $abs_top_builddir/tests/specs/updateinfo.xml $abs_top_builddir/tests/testroot/RPMS/repodata/
modifyrepo_c $abs_top_builddir/tests/updateinfo.xml $abs_top_builddir/tests/testroot/RPMS/repodata
cat << EOF > $abs_top_builddir/tests/testroot/etc/yum.repos.d/basic.repo
[basic]
name=basic
baseurl=file://$abs_top_builddir/tests/testroot/RPMS
gpgkey=file:///etc/pki/rpm-gpg/VMWARE-RPM-GPG-KEY
gpgcheck=0
enabled=1
EOF
]])

m4_define([TDNF_ENABLE_GPGCHECK],[[
sed -i 's/gpgcheck=0/gpgcheck=1/g' $abs_top_builddir/tests/testroot/etc/yum.repos.d/basic.repo
]])

m4_define([TDNF_CHROOT_CLEAN],[[
rm -rf $abs_top_builddir/tests/testroot
]])

AT_INIT
